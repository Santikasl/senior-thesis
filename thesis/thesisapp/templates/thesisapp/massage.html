{% extends 'thesisapp/header.html' %}
{% load static %}
{% block head %}
{% load customtags %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="{% static 'css/style.min.css' %}">
    <link rel="shortcut icon" href="{% static 'img/icon.png' %}" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat+Alternates&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
          rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullPage.js/3.1.2/fullpage.min.css"
          integrity="sha512-4rPgyv5iG0PZw8E+oRdfN/Gq+yilzt9rQ8Yci2jJ15rAyBmF0HBE4wFjBkoB72cxBeg63uobaj1UcNt/scV93w=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <script src="https://code.jquery.com/jquery-3.6.0.js"
            integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullPage.js/3.1.2/fullpage.min.js"
            integrity="sha512-gSf3NCgs6wWEdztl1e6vUqtRP884ONnCNzCpomdoQ0xXsk06lrxJsR7jX5yM/qAGkPGsps+4bLV5IEjhOZX+gg=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <title>Сообщения</title>
</head>

{% endblock %}

{% block name %}
<script>
    window.onload = function () {
        document.body.classList.add('loaded_hiding');
        window.setTimeout(function () {
            document.body.classList.add('loaded');
            document.body.classList.remove('loaded_hiding');
        }, 500);
    }
</script>
<!-- Прелоадер -->
<div class="preloader">
    <div class="preloader__row">
        <div class="preloader__item"></div>
        <div class="preloader__item"></div>
    </div>
</div>
 <div class="overlay-members">
                <div class="popup-members-add">
                    <h2>Создай свою группу!</h2>
                    <form id="form" action="{% url 'newgroup' %}"  method="post">
                        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
                        {% csrf_token %}
                        <div class="example-2">
                            <div class="form-group">
                                <input type="text" required id="id_name2" name="name" placeholder="Придумай название">
                            </label>
                            </div>
                        </div>

                        <select required multiple="multiple" class="male-select2" name="members">
                            {% for follow in follows %}
                            <option value="{{follow}}">{{follow.user.last_name}} {{follow.user.first_name}}</option>
                            {% endfor %}
                        </select>
                        <input type="submit" id="btn78" value="Создать">
                    </form>
                </div>
            </div>
<div class="wrapper">
    <div class="blur-search" id="overlay-blur">
        <div id="fullpage">
            <div class="section s1">
                <a href="#1"></a>
                <div class="section3" id="section2">
                    <div class="photo_gallery">
                        <div class="navigation">
                            <a href="{% url 'profile' %}">
                                <div class="home-container">
                                    <div class="home-img">
                                        <img src="{{ profile.img.url }}" alt="" width="50px">
                                    </div>
                                    <div class="home-text2">
                                        <p>Профиль</p>
                                    </div>
                                </div>
                            </a>
                            <a class="nav-bar" href="{% url 'main' %}">
                                <div class="home-container2">
                                    <div class="home-img2">
                                        <img src="{% static 'img/home.png' %}" alt="" width="20px">
                                    </div>
                                    <div class="home-text">
                                        <p>Главная</p>
                                    </div>
                                </div>
                            </a>
                            <div class="home-container2" id="message-btn">
                                <div class="home-img2">
                                    <img src="{% static 'img/message.png' %}" alt="" width="20px">
                                </div>
                                <div class="home-text">
                                    <p>Сообщения</p>
                                </div>
                            </div>

                            <div class="home-container2 add-post">
                                <div class="home-img2">
                                    <img src="{% static 'img/add.png' %}" alt="" width="20px">
                                </div>
                                <div class="home-text">
                                    <p>Создать</p>
                                </div>
                            </div>
                            <a class="nav-bar" href="{% url 'statistics' %}">
                                <div class="home-container2">
                                    <div class="home-img2">
                                        <img src="{% static 'img/statistic.png' %}" alt="" width="20px">
                                    </div>
                                    <div class="home-text">
                                        <p>Статистика</p>
                                    </div>
                                </div>
                            </a>
                             <a class="nav-bar" href="{% url 'settings' %}">
                            <div class="home-container2">
                                <div class="home-img2">
                                    <img src="{% static 'img/settings.png' %}" alt="" width="20px">
                                </div>
                                <div class="home-text">
                                    <p>Настройки</p>
                                </div>
                            </div>
                             </a>
                        </div>

                        <div class="message" id="message-content">
                            <div class="message-box">
                                <div class="chat">
                                    <div class="well">
                                        <form action="" id="search-form" method="post" autocomplete="off">
                                            {% csrf_token %}
                                            <input class="search2" type="search" name="" id="search-input2"  placeholder="Поиск">
                                        </form>

                                            <div class="add-members">
                                    <label class="ui button positive5 input-file ">
                                                <input class="ui button" type="button" name="add-file" >
                                                <p style="color: red;margin-top: -17px" id="like-img">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                                         style="margin-top: 4px" viewBox="0 0 100 100">
                                                        <rect x="40" y="0" width="20" height="100" rx="10" ry="10"
                                                              fill="#1e1e1e"/>
                                                        <rect x="0" y="40" width="100" height="20" rx="10" ry="10"
                                                              fill="#1e1e1e"/>
                                                    </svg>

                                                </p>
                                            </label>
                                    </div>
                                    </div>
                                    <div class="chat-message">
                                        <div class="chat-list">
                                            {% for group in groups %}
                                            <div class="message-chat-container"  data-chat-id="{{group.unic_id}}"
                                                 id="message{{group.pk}}">
                                                <div class="avatar-comment">
                                                  <p>{{group.name|two}}</p>
                                                </div>
                                                <div class="chat-text">
                                                    <p class="user-name-message">{{group.name}}</p>
                                                    <p class="last-message">{{group.messages.last|groupMessage}}</p>
                                                </div>
                                            </div>
                                            {% endfor %}
                                            <div id="message-chat-container">
                                            {% for follow in follows %}
                                            <div class="message-chat-container" data-chat-id="{{follow.pk}}"
                                                 id="message{{follow.pk}}">
                                                <div class="avatar-comment">
                                                    <img class="main-logo" src="{{ follow.img.url }}" alt=""
                                                         width="50px">
                                                </div>
                                                <div class="chat-text">
                                                    <p class="user-name-message">{{ follow.user.first_name }}&nbsp;&nbsp;{{follow.user.last_name }}</p>
                                                    {% if not follow|message:user %}
                                                    <p class="last-message">Начни диалог!</p>
                                                    {% else %}
                                                    {% for message in follow|message:user %}
                                                    {% if forloop.last %}
                                                    {% if message.sender and not message.sender.file %}
                                                    <p class="last-message">Вы: {{message.sender.content}}</p>
                                                    {% elif message.sender and message.sender.file%}
                                                    <p class="last-message">Вы: файл</p>
                                                    {% elif message.receiver and message.receiver.file%}
                                                    <p class="last-message">Файл</p>
                                                    {% else %}
                                                    <p class="last-message">{{message.receiver.content}}</p>
                                                    {% endif %}
                                                    {% endif %}
                                                    {% endfor %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endfor %}
                                            </div>

                                        </div>
                                    </div>

                                </div>
                                <div class="message-content_404" id="message-content_404">
                                    <img style="border-radius: 50px; margin-top: 20%"
                                         src="{% static 'img/message.gif' %}" alt=""
                                         width="150px">
                                    <p style=" font-family: 'Montserrat Alternates', sans-serif; font-size: 17px;">
                                        Подпишитесь на аккаунты других пользователей,</br> дождитесь взаимной подписки и начинайте общение!</p>
                                </div>
                                {% for follow in follows %}
                                <div class="message-content" id="chat{{follow.pk}}">

                                    <a href="/{{ follow.pk }}">
                                        <div class="message-chat">
                                            <div class="avatar-message">
                                                <img class="main-logo" src="{{ follow.img.url }}" alt=""
                                                     width="50px">
                                            </div>

                                            <div class="message-chat-text">
                                                <p class="user-name-message">{{ follow.user.first_name }} &nbsp;&nbsp;{{follow.user.last_name}}</p>

                                                {% if not follow|message:user%}
                                                <p class="last-message">Начни диалог первым!</p>
                                                {% else %}
                                                <p class="last-message">Продолжи общение!</p>
                                                {% endif %}

                                            </div>

                                        </div>
                                    </a>
                                    <div class="user-chat" id="user-message{{follow.pk}}">
                                        {% for message in follow|message:user %}

                                        {% if message.sender and not message.sender.content|smile and not message.sender.file %}
                                        <div style="width: 640px; margin-left: 20px; display: flex; justify-content: right">
                                            <div class="receiver">{{message.sender.content}}</div>
                                        </div>
                                        {% elif message.sender.file %}
                                        {% if message.sender.file|photo %}
                                        <!-- Добавленное условие для проверки фото -->
                                        <div style="width: 640px;  display: flex; justify-content: right">
                                             <a href="{{message.sender.file.url}}">
                                                <div class="receiver-photo">
                                                        <img src="{{message.sender.file.url}}" style="width: 100%;height: 100%; overflow: hidden; object-fit: cover;" alt="Photo" width="250px" height="300px">
                                                </div>
                                             </a>
                                        </div>
                                        {% else %}
                                        <div style="width: 640px; margin-left: 20px; display: flex; justify-content: right">
                                            <div class="receiver"><a href="{{message.sender.file.url}}">{{message.sender.file}}</a>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% elif message.sender and message.sender.content|smile %}
                                        <div style="width: 640px; margin-left: 20px; display: flex; justify-content: right">
                                            <div class="receiver_emoji">{{message.sender.content}}</div>
                                        </div>
                                        {% elif message.receiver and message.receiver.content|smile and not message.receiver.file %}
                                        <div style="width: 340px; margin-left: 20px; display: flex; justify-content: left;text-align: left;">
                                            <div class="sender_emoji">{{message.receiver.content}}</div>
                                        </div>
                                        {% elif message.receiver.file %}
                                        {% if message.receiver.file|photo %}
                                        <div style="width: 640px;  display: flex; justify-content: left">
                                            <a href="{{message.receiver.file.url}}">
                                            <div class="sent-photo">
                                                    <img src="{{message.receiver.file.url}}" style="width: 100%;height: 100%; overflow: hidden; object-fit: cover;" alt="Photo" width="250px" height="300px">
                                            </div>  </a>
                                        </div>
                                        {% else %}
                                        <div style="width: 340px; margin-left: 0px; display: flex; justify-content: left;text-align: left;">
                                            <div class="sender"><a href="{{message.receiver.file.url}}">{{message.receiver.file}}</a>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% else %}
                                        <div class="sender">{{message.receiver.content}}</div>
                                        {% endif %}
                                        {% endfor %}
                                    </div>

                                    <div class="sent-message">
                                        <form action="{% url 'message' %}" method="post" class="send-message"
                                              id="q{{follow.pk}}">
                                            {% csrf_token %}
                                            <input type="hidden" name="follow_pk" value="{{follow.pk}}">
                                            <textarea required class="sent" id="message-btn{{follow.pk}}"
                                                      type="text"
                                                      name="message"
                                                      placeholder="Напишите сообщение" ></textarea>
                                            <button class="ui button positive3"
                                                    type="submit"><p
                                                    style="color: red;"
                                                    id="like-img">
                                               <svg style="color: #057ef7;" xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-telegram" viewBox="0 0 16 16"> <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.287 5.906c-.778.324-2.334.994-4.666 2.01-.378.15-.577.298-.595.442-.03.243.275.339.69.47l.175.055c.408.133.958.288 1.243.294.26.006.549-.1.868-.32 2.179-1.471 3.304-2.214 3.374-2.23.05-.012.12-.026.166.016.047.041.042.12.037.141-.03.129-1.227 1.241-1.846 1.817-.193.18-.33.307-.358.336a8.154 8.154 0 0 1-.188.186c-.38.366-.664.64.015 1.088.327.216.589.393.85.571.284.194.568.387.936.629.093.06.183.125.27.187.331.236.63.448.997.414.214-.02.435-.22.547-.82.265-1.417.786-4.486.906-5.751a1.426 1.426 0 0 0-.013-.315.337.337 0 0 0-.114-.217.526.526 0 0 0-.31-.093c-.3.005-.763.166-2.984 1.09z" fill="#057ef7"></path> </svg>
                                            </p></button>
                                        </form>
                                        <form action="{% url 'sent_file' %}" method="post" enctype="multipart/form-data"
                                              class="send-message" id="q{{follow.pk}}">
                                            {% csrf_token %}
                                            <input type="hidden" name="follow_pk" value="{{follow.pk}}">
                                            <input type="hidden" name="message" value="🧡" id="like">
                                            <label class="ui button positive2 input-file">

                                                <input class="ui button positive2" type="file" name="add-file"
                                                       onchange="this.form.submit()" id="q{{follow.pk}}">
                                                <p style="color: red;margin-top: 8px" id="like-img">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25"
                                                         style="margin-top: 4px" viewBox="0 0 100 100">
                                                        <rect x="40" y="0" width="20" height="100" rx="10" ry="10"
                                                              fill="#1e1e1e"/>
                                                        <rect x="0" y="40" width="100" height="20" rx="10" ry="10"
                                                              fill="#1e1e1e"/>
                                                    </svg>

                                                </p>
                                            </label>

                                        </form>
                                        <form action="{% url 'message' %}" method="post" class="send-message"
                                              id="q{{follow.pk}}">
                                            {% csrf_token %}
                                            <input type="hidden" name="follow_pk" value="{{follow.pk}}">
                                            <input type="hidden" name="message" value="🧡" id="like">

                                            <button class="ui button positive2"
                                                    type="submit"><p
                                                    style="color: red;"
                                                    id="like-img">
                                                ❤
                                            </p></button>
                                        </form>
                                    </div>
                                </div>
                                {% endfor %}


                                 {% for group in groups %}

                                 <div class="overlay3" id="myOverlay3">
                                    <div class="popup-members">
                                        <h2 class="titel">Учасники чата</h2>
                                        <div>
                                            <div class="followers-scroll">
                                                {% for members in group.members.all %}
                                                <a href="{% url 'search_profile' members.id%}">
                                                    <div class="follow-div">
                                                        <div class="img">
                                                            <img src="{{ members.img.url }}" alt="" width="60px">
                                                        </div>
                                                        <p class="nic">{{ members.name }}</p>
                                                    </div>
                                                </a>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="message-content" id="group{{group.unic_id}}">

                                    <div class="members">
                                        <div class="message-chat">
                                            <div class="avatar-comment">
                                                  <p>ПО</p>
                                            </div>

                                            <div class="message-chat-text">
                                                <p class="user-name-message">{{ group.name }}</p>
                                                <p class="last-message2">Добро пожаловать в {{ group.name }}</p>
                                            </div>

                                        </div>
                                    </div>
                                    <div class="user-chat" id="user-message-group{{group.unic_id}}">
                                         {% for message in group.pk|messageGroup:user %}
                                        {% if message.sender and not message.sender.content|smile and not message.sender.file %}
                                        <div style="width: 640px; margin-left: 20px; display: flex; justify-content: right">
                                            <div class="receiver">{{message.sender.content}}</div>
                                        </div>
                                        {% elif message.sender.file %}
                                        {% if message.sender.file|photo %}
                                        <!-- Добавленное условие для проверки фото -->
                                        <div style="width: 640px;  display: flex; justify-content: right">

                                             <a href="{{message.sender.file.url}}">
                                                <div class="receiver-photo">
                                                        <img src="{{message.sender.file.url}}" style="width: 100%;height: 100%; overflow: hidden; object-fit: cover;" alt="Photo" width="250px" height="300px">
                                                </div>
                                             </a>
                                        </div>
                                        {% else %}
                                        <div style="width: 640px; margin-left: 20px; display: flex; justify-content: right">

                                            <div class="receiver"><a href="{{message.sender.file.url}}">{{message.sender.file}}</a>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% elif message.sender and message.sender.content|smile %}
                                        <div style="width: 640px; margin-left: 20px; display: flex; justify-content: right">
                                            <div class="receiver_emoji">{{message.sender.content}}</div>
                                        </div>
                                        {% elif message.receiver and message.receiver.content|smile and not message.receiver.file %}
                                        <div style="width: 340px; margin-left: 47px; display: flex; justify-content: left;text-align: left;">
                                             <a href="/{{ message.receiver.sender.pk }}">
                                             <div class="avatar-message2" style="margin-top: 8px">
                                                <img class="main-logo" src="{{ message.receiver.sender.img.url }}" alt="" width="40px">
                                            </div>
                                             </a>
                                            <div class="sender_emoji">{{message.receiver.content}}</div>
                                        </div>
                                        {% elif message.receiver.file %}
                                        {% if message.receiver.file|photo %}
                                        <div style="width: 640px; margin-left: 47px;  display: flex; justify-content: left">
                                            <a href="/{{ message.receiver.sender.pk }}">
                                             <div class="avatar-message2" style="margin-top: 40%">
                                                <img class="main-logo" src="{{ message.receiver.sender.img.url }}" alt="" width="40px">
                                            </div>
                                            </a>
                                            <a href="{{message.receiver.file.url}}">

                                            <div class="sent-photo2">
                                                    <img src="{{message.receiver.file.url}}" style="width: 100%;height: 100%; overflow: hidden; object-fit: cover;" alt="Photo" width="250px" height="300px">
                                            </div>  </a>
                                        </div>
                                        {% else %}
                                        <div style="width: 340px; margin-left: 47px; display: flex; justify-content: left;text-align: left;">
                                            <a href="/{{ message.receiver.sender.pk }}">
                                            <div class="avatar-message2">
                                                <img class="main-logo" src="{{ message.receiver.sender.img.url }}" alt="" width="40px">
                                            </div>
                                                    </a>
                                            <div class="sender" style="margin-left: 15px; margin-top: -2px"><a href="{{message.receiver.file.url}}">{{message.receiver.file}}</a>
                                            </div>

                                        </div>
                                        {% endif %}
                                        {% else %}
                                     <div style="width: 340px; margin-left: 47px; display: flex; justify-content: left;text-align: left;">
                                         <a href="/{{ message.receiver.sender.pk }}">
                                     <div class="avatar-message2">
                                                <img class="main-logo" src="{{ message.receiver.sender.img.url }}" alt="" width="40px">
                                            </div>
                                         </a>
                                        <div class="sender"  style="margin-left: 15px; margin-top: -2px">{{message.receiver.content}}</div>
                                     </div>
                                        {% endif %}
                                        {% endfor %}
                                    </div>

                                    <div class="sent-message">
                                        <form action="{% url 'message' %}" method="post" class="send-message-to-group"
                                              id="q{{group.unic_id}}">
                                            {% csrf_token %}
                                            <input type="hidden" name="group_pk" value="{{group.unic_id}}">
                                            <textarea required class="sent" id="message-btn{{group.unic_id}}"
                                                      type="text"
                                                      name="message"
                                                      placeholder="Напишите сообщение" ></textarea>
                                            <button class="ui button positive4"
                                                    type="submit"><p
                                                    style="color: red;"
                                                    id="like-img">
                                               <svg style="color: #057ef7; margin-top: 5px" xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-telegram" viewBox="0 0 16 16"> <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.287 5.906c-.778.324-2.334.994-4.666 2.01-.378.15-.577.298-.595.442-.03.243.275.339.69.47l.175.055c.408.133.958.288 1.243.294.26.006.549-.1.868-.32 2.179-1.471 3.304-2.214 3.374-2.23.05-.012.12-.026.166.016.047.041.042.12.037.141-.03.129-1.227 1.241-1.846 1.817-.193.18-.33.307-.358.336a8.154 8.154 0 0 1-.188.186c-.38.366-.664.64.015 1.088.327.216.589.393.85.571.284.194.568.387.936.629.093.06.183.125.27.187.331.236.63.448.997.414.214-.02.435-.22.547-.82.265-1.417.786-4.486.906-5.751a1.426 1.426 0 0 0-.013-.315.337.337 0 0 0-.114-.217.526.526 0 0 0-.31-.093c-.3.005-.763.166-2.984 1.09z" fill="#057ef7"></path> </svg>
                                            </p></button>
                                        </form>
                                        <form action="{% url 'sent_file' %}" method="post" enctype="multipart/form-data"
                                              class="send-message" id="q{{group.unic_id}}">
                                            {% csrf_token %}
                                            <input type="hidden" name="unic_id" value="{{group.unic_id}}">
                                            <label class="ui button positive2 input-file">

                                                <input class="ui button positive2" type="file" name="add-file"
                                                       onchange="this.form.submit()" id="q{{group.unic_id}}">
                                                <p style="color: red;margin-top: 8px" id="like-img">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25"
                                                         style="margin-top: 4px" viewBox="0 0 100 100">
                                                        <rect x="40" y="0" width="20" height="100" rx="10" ry="10"
                                                              fill="#1e1e1e"/>
                                                        <rect x="0" y="40" width="100" height="20" rx="10" ry="10"
                                                              fill="#1e1e1e"/>
                                                    </svg>

                                                </p>
                                            </label>

                                {% endfor %}





        </div>
    </div>
    <div class="section s2">
        <a href="#2"></a>


    </div>

</div>
</div>
</div>
<script>
    new fullpage('#fullpage', {
        // здесь параметры
        autoScrolling: true,
        anchors: ['1', '2', '3'],
        scrollHorizontally: true,
        showActiveTooltip: true,
        controlArrows: false,
        slidesNavigation: true,
        normalScrollElements: '.s2, .photo_gallery, .sent'
    });
</script>
<script src="http://code.jquery.com/jquery-2.0.2.min.js"></script>
<script src="{% static 'js/like.js' %}" defer></script>
<script src="{% static 'js/search.js' %}" defer></script>
<script src="{% static 'js/searchChat.js' %}" defer></script>
<script src="{% static 'js/comments.js' %}" defer></script>
<script src="{% static 'js/commentsLike.js' %}" defer></script>
<script src="{% static 'js/sendMessage.js' %}" defer></script>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script>
    $('.add-post').click(function () {
        $('.overlay').fadeIn();
    });

    // Закрытие окна на крестик
    $('.close-popup').click(function () {
        $('.overlay').fadeOut();
    });

    // Закрытие окна на поле
    $(document).mouseup(function (e) {
        var popup = $('.popup');
        if (e.target != popup[0] && popup.has(e.target).length === 0) {
            $('.overlay').fadeOut();
        }
    });
</script>
<script>
    (function () {

        'use strict';

        $('.input-file').each(function () {
            var $input = $(this),
                $label = $input.next('.js-labelFile'),
                labelVal = $label.html();

            $input.on('change', function (element) {
                var fileName = '';
                if (element.target.value) fileName = element.target.value.split('\\').pop();
                fileName ? $label.addClass('has-file').find('.js-fileName').html(fileName) : $label.removeClass('has-file').html(labelVal);
            });
        });

    })();
</script>

<script>
    $(document).ready(function () {
        $('a.myLinkModal').click(function (event) {
            event.preventDefault();
            $('#myOverlay').fadeIn(297, function () {
                $('#myModal')
                    .css('display', 'block')
                    .animate({
                        opacity: 1
                    }, 198);
            });
        });

        $('#myModal__close, #myOverlay').click(function () {
            $('#myModal').animate({
                    opacity: 0
                }, 198,
                function () {
                    $(this).css('display', 'none');
                    $('#myOverlay').fadeOut(297);
                });
        });
    });
</script>

<script src="http://code.jquery.com/jquery-2.0.2.min.js"></script>

<script>
    $(document).ready(function () {
        //Скрыть PopUp при загрузке страницы
        PopUpHide();
    });

    //Функция отображения PopUp
    function PopUpShow() {
        $("#popup1").show();

    }

    //Функция скрытия PopUp
    function PopUpHide() {
        $("#popup1").hide();
    }
</script>

<script>
    const messageBtn = document.getElementById('message-btn')
    const photoContent = document.getElementById('photo-content')
    const messageContent = document.getElementById('message-content')
    const section2 = document.getElementById('section2')
    messageBtn.onclick = function () {
        photoContent.style.display = "none";
        messageContent.style.display = "unset";
        section2.style.overflowY = "hidden";

    };
    let intervalId;
    let counter;
    const message404 = document.getElementById("message-content_404");
    const messageContainers = document.getElementsByClassName("message-chat-container");
    const chats = document.querySelectorAll("[id^='chat']");

    for (let i = 0; i < messageContainers.length; i++) {
        let messageContainer = messageContainers[i];
        messageContainer.addEventListener("click", function () {
            let chatId = messageContainer.getAttribute("data-chat-id");
            hideAllChats();
            message404.style.display = "none";
            showChat(chatId);
            getCounters(chatId)
            intervalId = setInterval(function () {
                receiveMsg(chatId); // Повторный вызов каждые 2 секунды
            }, 5000);

        });
    }

    function hideAllChats() {
        for (let i = 0; i < chats.length; i++) {
            let chat = chats[i];
            chat.style.display = "none";
            clearInterval(intervalId);
        }
    }


    function showChat(chatId) {

        let chat = document.getElementById("chat" + chatId);
        if (chat) {
            chat.style.display = "block";
            message404.style.display = "none";
            let message = document.getElementById("user-message" + chatId)
            const scrollHeight = message.scrollHeight;
            const scrollOptions = {
                top: scrollHeight,
                behavior: "smooth" // Добавляем плавность
            };
            message.scrollTo(scrollOptions);

        }
        let group = document.getElementById("group"+chatId)
         if (group) {
            group.style.display = "block";
            message404.style.display = "none";
            let message = document.getElementById("user-message-group" + chatId)
            const scrollHeight = message.scrollHeight;
            const scrollOptions = {
                top: scrollHeight,
                behavior: "smooth" // Добавляем плавность
            };
            message.scrollTo(scrollOptions);

        }
    }



    function getCounters(followPk) {
        let url = "{% url 'get_count' %}?follow_pk=" + followPk;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                counters = data;
            })
            .catch((error) => {
                console.error('Error:', error);
            });
    }



function containsSmileys(text) {
    var regex = /[\uD83C-\uDBFF\uDC00-\uDFFF]+/g; // Регулярное выражение для поиска смайликов
    return regex.test(text);
}


function isPhoto(path) {
  var extension = path.substring(path.lastIndexOf('.')).toLowerCase();
  var imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp'];

  if (imageExtensions.includes(extension)) {
    return true;
  } else {
    return false;
  }
}


function isFilePath(path) {
      var extension = path.substring(path.lastIndexOf('.')).toLowerCase();
  var imageExtensions = ['.docx', '.mp4', '.pdf', '.py', '.cs', '.rar', '.zip', '.cxl', '.exe', '.mp3', '.txt', '.doc'];

  if (imageExtensions.includes(extension)) {
    return true;
  } else {
    return false;
  }
}
    function receiveMsg(followPk) {
        let url = "{% url 'receive_message' %}?follow_pk=" + followPk;
        let message_container;
        let scrollOptions;
        let scrollHeight;
        if (followPk.length === 3){
            message_container = document.getElementById('user-message-group' + followPk);
            scrollHeight = message_container.scrollHeight;
             scrollOptions = {
            top: scrollHeight,
            behavior: "smooth" // Добавляем плавность
        };
        }
        else {
            message_container = document.getElementById('user-message' + followPk);
            scrollHeight = message_container.scrollHeight;
            scrollOptions = {
            top: scrollHeight,
            behavior: "smooth" // Добавляем плавность
        };
        }



        fetch(url, {
            method: 'GET',
            headers: {
                'X-Follow-Pk': followPk,
            },
        })
            .then(response => response.json())
            .then(data => {
                if (data.arr.length === 0) {
                    // Если нет новых сообщений
                } else {
                    let lastMsg = data.arr[data.arr.length - 1];
                    let lastPhoto = data.user[data.user.length - 1];
                    let userPk = data.userPk[data.userPk.length - 1];
                    if (counters === data.arr.length) {
                    } else {
                        counters = data.arr.length;
                        if (containsSmileys(lastMsg)) {
                            if (followPk.length === 3) {
                               message_container.innerHTML += `
                                    <div style="width: 340px; margin-left: 47px; display: flex; justify-content: left;text-align: left;">
                                    <a href="/${userPk}">
                                    <div class="avatar-message2" style="margin-top: 8px">
                                        <img class="main-logo" src="${lastPhoto}" alt=""
                                             width="40px">
                                    </div>
                                    </a>
                                    <div class="sender_emoji">${lastMsg}</div>
                                </div> `
                            }
                            else {
                                 message_container.innerHTML += `
                                            <div class="sender_emoji">${lastMsg}</div>
            `
                            }
                            message_container.scrollTo(scrollOptions);
                        }
                          else if(isPhoto(lastMsg)){

                    if (followPk.length === 3){
                        message_container.innerHTML += ` <div style="width: 640px; margin-left: 47px;  display: flex; justify-content: left">
  <a href="/${userPk}">
                                             <div class="avatar-message2" style="margin-top: 40%">
                                                <img class="main-logo" src="${lastPhoto}" alt="" width="40px">
                                            </div>
                                            </a>
                                            <a href="${lastMsg}}">

                                            <div class="sent-photo2">
                                                    <img src="${lastMsg}" style="width: 100%;height: 100%; overflow: hidden; object-fit: cover;" alt="Photo" width="250px" height="300px">
                                            </div>  </a>
                                        </div>
            `
                message_container.scrollTo(scrollOptions);
                    }
                    else {
                        message_container.innerHTML += `<div style="width: 640px; margin-left: 35px;  display: flex; justify-content: left">
                                            <a href="${lastMsg}">

                                            <div class="sent-photo2">
                                                    <img src="${lastMsg}" style="width: 100%;height: 100%; overflow: hidden; object-fit: cover;" alt="Photo" width="250px" height="300px">
                                            </div>  </a>
                                        </div>
            `
                message_container.scrollTo(scrollOptions);
                    }

            }
                          else if(isFilePath(lastMsg)) {
                            if (followPk.length === 3) {
                                message_container.innerHTML += `
                                <div style="width: 340px; margin-left: 47px; display: flex; justify-content: left;text-align: left;">
                                 <a href="/${userPk}">
                                            <div class="avatar-message2">
                                                <img class="main-logo" src="${lastPhoto}" alt="" width="40px">
                                            </div>
                                            </a>
                                            <div class="sender" style="margin-left: 15px; margin-top: -2px"><a href="${lastMsg}">${lastMsg}</a>
                                            </div>
                                        </div>
                                `
                            } else {
                                message_container.innerHTML += `  <div
                                style="width: 340px; margin-left: 10px; display: flex; justify-content: left;text-align: left;">
                                <div class="sender"><a href="${lastMsg}">${lastMsg}</a>
                                </div>
                            </div>`
                            }
                        }
                        else {
                               if (followPk.length === 3) {
                                message_container.innerHTML += `

                       <div style="width: 340px; margin-left: 47px; display: flex; justify-content: left;text-align: left;">
                        <a href="/${userPk}">
                                     <div class="avatar-message2">
                                                <img class="main-logo" src="${lastPhoto}" alt="" width="40px">
                                            </div>
                                            </a>
                                        <div class="sender"  style="margin-left: 15px; margin-top: -2px">${lastMsg}</div>
                                     </div>

                `;
                            }
                               else {
                                   message_container.innerHTML += `

                        <div class="sender">${lastMsg}</div>

                `;
                               }
                        }
                        message_container.scrollTo(scrollOptions);
                    }
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            });
    }

 $(document).on('click', '.members', function (e) {
        $('#myOverlay3').fadeIn();
    });

    $(document).mouseup(function (e) {
        let popup = $('.popup-members');
        if (e.target != popup[0] && popup.has(e.target).length === 0) {
            $('.overlay3').fadeOut();
        }

    });


</script>
<script>
    $(document).on('click', '.add-members', function (e) {
        console.log("wfhewoiuwheug")
        $('.overlay-members').fadeIn();
    });

    $(document).mouseup(function (e) {
        let popup = $('.popup-members-add');
        if (e.target != popup[0] && popup.has(e.target).length === 0) {
            $('.overlay-members').fadeOut();
        }
    });
</script>

{% endblock %}